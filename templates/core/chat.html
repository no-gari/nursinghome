<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareBridge - 채팅</title>
    <!-- Tailwind & Fonts (공통 헤더/푸터 스타일 적용 위해 추가) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Pretendard',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif; background:linear-gradient(160deg,#ffffff 0%,#f5f8fb 55%,#eef3f9 100%); color:#374151; line-height:1.6; display:flex; flex-direction:column; min-height:100vh; }
        .hdr{transition:height .2s ease, box-shadow .2s ease, background .2s ease; backdrop-filter:blur(8px);} .hdr:not(.shrink){height:70px;} .hdr.shrink{height:56px;}
        main.chat-page { flex:1; display:flex; flex-direction:column; padding-top:8px; }
        .chat-container { flex:1; display:flex; flex-direction:column; width:100%; max-width:960px; margin:0 auto; padding:0 14px; }
        /* 내부 헤더 제거됨 */
        .chat-messages { flex:1; overflow-y:auto; padding:16px 4px 140px; background:transparent; }
        .suggestions { display:flex; flex-wrap:wrap; gap:10px; padding:12px 4px 4px; }
        .suggestion-chip { background:#ffffff; border:1px solid #e2e8f0; border-radius:9999px; padding:6px 14px; font-size:12px; font-weight:500; color:#334155; cursor:pointer; display:inline-flex; align-items:center; gap:6px; box-shadow:0 2px 4px rgba(15,23,42,0.06); transition:.2s; }
        .suggestion-chip:hover { background:#f1f5f9; border-color:#cbd5e1; }
        .message { margin-bottom:24px; display:flex; gap:12px; }
        .message.user { justify-content:flex-end; }
        .message.user .message-content { background:#2563eb; color:#fff; max-width:70%; }
        .message.bot { justify-content:flex-start; }
        .message.bot .message-content { background:#ffffff; color:#374151; max-width:80%; border:1px solid #e5e7eb; }
        .message-avatar { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; flex-shrink:0; box-shadow:0 2px 4px rgba(15,23,42,0.08); }
        .message.user .message-avatar { background:#2563eb; color:#fff; }
        .message.bot .message-avatar { background:#6366f1; color:#fff; }
        .message-content { padding:14px 18px; border-radius:18px; line-height:1.58; font-size:15px; }
        .chat-input-container { position:fixed; left:0; right:0; bottom:0; background:rgba(255,255,255,.9); border-top:1px solid #e2e8f0; backdrop-filter:blur(10px); padding:18px 16px 22px; }
        .chat-input-wrapper { max-width:960px; margin:0 auto; position:relative; }
        .chat-input { width:100%; padding:15px 20px; border:1px solid #d1d5db; border-radius:14px; font-size:15px; outline:none; transition:.25s; padding-right:60px; resize:none; min-height:52px; max-height:150px; background:#fff; box-shadow:0 2px 6px rgba(15,23,42,0.06); }
        .chat-input:focus { border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,0.18); }
        .chat-send-btn { position:absolute; right:8px; bottom:8px; background:#6366f1; color:#fff; border:none; width:40px; height:40px; border-radius:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:.25s; box-shadow:0 4px 14px -2px rgba(99,102,241,.4); }
        .chat-send-btn:hover:not(:disabled) { background:#4f46e5; }
        .chat-send-btn:disabled { background:#94a3b8; cursor:not-allowed; box-shadow:none; }
        .loading { display:flex; align-items:center; gap:8px; color:#64748b; font-style:italic; }
        .loading-dots { display:flex; gap:4px; }
        .loading-dot { width:6px; height:6px; background:#64748b; border-radius:50%; animation:loading 1.5s infinite; }
        .loading-dot:nth-child(2){animation-delay:.2s;} .loading-dot:nth-child(3){animation-delay:.4s;}
        @keyframes loading { 0%,60%,100%{transform:translateY(0);} 30%{transform:translateY(-6px);} }
        .error-message { background:#fef2f2 !important; color:#dc2626 !important; border-color:#fecaca !important; }
        @media (max-width: 768px){ .chat-messages { padding:12px 0 140px; } .message-content { font-size:14px; } .chat-input-container { padding:14px 12px 18px; } .suggestions { gap:8px; } }
    </style>
</head>
<body>
<header id="siteHeader" class="hdr sticky top-0 z-40 bg-white/80 border-b border-slate-200 flex flex-col justify-center">
    {% include 'core/_navbar.html' %}
</header>
<meta name="csrf-token" content="{{ csrf_token }}">
<main class="chat-page">
  <div id="app" class="flex-1 flex flex-col">
    <form style="display:none;">{% csrf_token %}</form>
    <div class="chat-container">
      <!-- 초기 예시 프롬프트 (메시지 없을 때만 표시) -->
      <div v-if="messages.length === 0 && !isLoading" class="suggestions" aria-label="예시 질문">
        <button type="button" class="suggestion-chip" @click="setExample('서울 A등급 요양원 추천해줘')">🏆 <span>서울 A등급 요양원 추천</span></button>
        <button type="button" class="suggestion-chip" @click="setExample('대기자가 적은 곳 찾아줘')">⏱ <span>대기 적은 곳</span></button>
        <button type="button" class="suggestion-chip" @click="setExample('물리치료 프로그램 있는 곳 알려줘')">🏃‍♂️ <span>물리치료 프로그램</span></button>
        <button type="button" class="suggestion-chip" @click="setExample('비급여 비용 저렴한 곳 비교해줘')">💰 <span>비급여 저렴 비교</span></button>
        <button type="button" class="suggestion-chip" @click="setExample('경기도 10년 이상 운영 A등급 추천')">📊 <span>경기 10년+ A등급</span></button>
      </div>
      <div class="chat-messages" ref="messagesContainer">
        <!-- ...existing message loop... -->
        <div v-for="message in messages" :key="message.id" :class="['message', message.type]">
          <div class="message-avatar"><span v-if="message.type === 'user'">👤</span><span v-else>🤖</span></div>
          <div class="message-content" :class="{ 'error-message': message.isError }"><div v-html="formatMessage(message.content)"></div></div>
        </div>
        <div v-if="isLoading" class="message bot">
          <div class="message-avatar">🤖</div>
          <div class="message-content loading"><span>답변 생성 중</span><div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></div>
        </div>
      </div>
    </div>
  </div>
</main>
<!-- Footer intentionally omitted for chat focus -->
<div class="chat-input-container">
  <div class="chat-input-wrapper">
    <textarea v-model="currentMessage" @keypress.enter.prevent="sendMessage" :disabled="isLoading" placeholder="무엇이든 물어보세요... (예: 서울 A등급 요양원)" class="chat-input" rows="1"></textarea>
    <button @click="sendMessage" :disabled="isLoading || !currentMessage.trim()" class="chat-send-btn" aria-label="전송">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>
<script>
const { createApp } = Vue;
createApp({
  data(){return{messages:[],currentMessage:'',isLoading:false,messageId:1}},
  mounted(){ const p=new URLSearchParams(window.location.search); const init=p.get('message'); if(init){ this.currentMessage=decodeURIComponent(init); this.sendMessage(); } this.setupCSRF(); },
  methods:{
    setExample(txt){ this.currentMessage=txt; this.sendMessage(); },
    setupCSRF(){ const t=document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')||document.querySelector('[name=csrfmiddlewaretoken]')?.value||this.getCookie('csrftoken'); if(t){ axios.defaults.headers.common['X-CSRFToken']=t; axios.defaults.headers.common['X-Requested-With']='XMLHttpRequest'; } },
    getCookie(name){ let v=null; if(document.cookie&&document.cookie!==''){ const cs=document.cookie.split(';'); for(let i=0;i<cs.length;i++){ const c=cs[i].trim(); if(c.substring(0,name.length+1)===(name+'=')){ v=decodeURIComponent(c.substring(name.length+1)); break; } } } return v; },
    async sendMessage(){ if(!this.currentMessage.trim()||this.isLoading) return; const userMsg={id:this.messageId++,type:'user',content:this.currentMessage,timestamp:new Date()}; this.messages.push(userMsg); const toSend=this.currentMessage; this.currentMessage=''; this.isLoading=true; this.scrollToBottom(); try{ const r=await axios.post('/api/chat/',{query:toSend}); const botMsg={id:this.messageId++,type:'bot',content:r.data.response||r.data.answer,sources:r.data.sources||[],timestamp:new Date()}; this.messages.push(botMsg); }catch(e){ console.error(e); let msg='죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.'; if(e.response && e.response.status===403){ try{ const retry=await fetch('/api/chat/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:toSend}),credentials:'include'}); if(retry.ok){ const data=await retry.json(); this.messages.push({id:this.messageId++,type:'bot',content:data.answer||data.response||'',sources:data.sources||[],timestamp:new Date()}); this.isLoading=false; this.scrollToBottom(); return; } }catch(e2){ console.error('retry fail',e2);} msg='403 (권한/CSRF) 문제입니다. 서버 로그 확인 필요.'; } else if(e.response && e.response.data && e.response.data.error){ msg=e.response.data.error; } this.messages.push({id:this.messageId++,type:'bot',content:msg,isError:true,timestamp:new Date()}); } finally { this.isLoading=false; this.scrollToBottom(); } },
    formatMessage(c){ return c.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/\n/g,'<br>'); },
    scrollToBottom(){ this.$nextTick(()=>{ const el=this.$refs.messagesContainer; if(el){ el.scrollTop=el.scrollHeight; } }); }
  }
}).mount('#app');
// 헤더 축소 효과 유지
const siteHeader=document.getElementById('siteHeader'); function onScroll(){ if(window.scrollY>16) siteHeader.classList.add('shrink'); else siteHeader.classList.remove('shrink'); } window.addEventListener('scroll',onScroll); onScroll();
</script>
</body>
</html>
