<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>요양시설 검색</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .filter-card {
            transition: all 0.3s ease;
        }
        .filter-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .facility-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        .facility-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }
        .tag {
            @apply inline-block px-2 py-1 text-xs rounded-full;
        }
        .tag-grade-a { @apply bg-green-100 text-green-800; }
        .tag-grade-b { @apply bg-blue-100 text-blue-800; }
        .tag-grade-c { @apply bg-yellow-100 text-yellow-800; }
        .tag-grade-d { @apply bg-orange-100 text-orange-800; }
        .tag-grade-e { @apply bg-red-100 text-red-800; }
        .tag-default { @apply bg-gray-100 text-gray-800; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 헤더 -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="{% url 'core:main' %}" class="text-2xl font-bold text-blue-600">
                        CareBridge
                    </a>
                </div>
                <nav class="flex space-x-8">
                    <a href="{% url 'core:main' %}" class="text-gray-700 hover:text-blue-600 transition-colors">홈</a>
                    <a href="{% url 'core:facility_list' %}" class="text-blue-600 font-semibold">시설검색</a>
                    <a href="{% url 'core:chat' %}" class="text-gray-700 hover:text-blue-600 transition-colors">AI 상담</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- 필터 사이드바 -->
            <div class="lg:w-80 space-y-6">
                <form method="GET" class="space-y-6">
                    <!-- 검색어 -->
                    <div class="bg-white rounded-lg p-6 shadow-sm filter-card">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-search mr-2 text-blue-600"></i>검색
                        </h3>
                        <input type="text" name="search" value="{{ current_filters.search }}"
                               placeholder="시설명을 입력하세요"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- 지역 선택 -->
                    <div class="bg-white rounded-lg p-6 shadow-sm filter-card">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-map-marker-alt mr-2 text-blue-600"></i>지역
                        </h3>
                        <div class="space-y-4">
                            <select name="sido" id="sido" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">시/도 선택</option>
                                {% for sido_name in regions.keys %}
                                    <option value="{{ sido_name }}" {% if current_filters.sido == sido_name %}selected{% endif %}>{{ sido_name }}</option>
                                {% endfor %}
                            </select>
                            <select name="sigungu" id="sigungu" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">시/군/구 선택</option>
                            </select>
                        </div>
                    </div>

                    <!-- 평가등급 -->
                    <div class="bg-white rounded-lg p-6 shadow-sm filter-card">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-star mr-2 text-blue-600"></i>평가등급
                        </h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="grade" value="" {% if not current_filters.grade %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="tag tag-default">전체</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="grade" value="A등급"
                                       {% if current_filters.grade == 'A등급' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="tag tag-grade-a">A등급</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="grade" value="B등급"
                                       {% if current_filters.grade == 'B등급' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="tag tag-grade-b">B등급</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="grade" value="C등급"
                                       {% if current_filters.grade == 'C등급' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="tag tag-grade-c">C등급</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="grade" value="D등급"
                                       {% if current_filters.grade == 'D등급' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="tag tag-grade-d">D등급</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="grade" value="E등급"
                                       {% if current_filters.grade == 'E등급' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="tag tag-grade-e">E등급</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="grade" value="등급외"
                                       {% if current_filters.grade == '등급외' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span class="tag tag-default">등급외</span>
                            </label>
                        </div>
                    </div>

                    <!-- 시설규모 -->
                    <div class="bg-white rounded-lg p-6 shadow-sm filter-card">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-building mr-2 text-blue-600"></i>시설규모
                        </h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="size" value="" {% if not current_filters.size %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>전체</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="size" value="대형"
                                       {% if current_filters.size == '대형' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>대형</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="size" value="중형"
                                       {% if current_filters.size == '중형' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>중형</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="size" value="소형"
                                       {% if current_filters.size == '소형' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>소형</span>
                            </label>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-6 shadow-sm filter-card">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-calendar mr-2 text-blue-600"></i>설립년도
                        </h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="establishment" value="" {% if not current_filters.establishment %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>전체</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="establishment" value="신규시설"
                                       {% if current_filters.establishment == '신규시설' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>신규시설</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="establishment" value="5년이내"
                                       {% if current_filters.establishment == '5년이내' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>5년이내</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="establishment" value="10년이내"
                                       {% if current_filters.establishment == '10년이내' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>10년이내</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="establishment" value="10년이상"
                                       {% if current_filters.establishment == '10년이상' %}checked{% endif %}
                                       class="mr-2 text-blue-600 focus:ring-blue-500">
                                <span>10년이상</span>
                            </label>
                        </div>
                    </div>
                    <!-- 버튼 -->
                    <div class="space-y-3">
                        <a href="{% url 'core:facility_list' %}" class="block w-full bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors text-center">
                            <i class="fas fa-refresh mr-2"></i>초기화
                        </a>
                    </div>
                </form>
            </div>

            <!-- 결과 영역 -->
            <div class="flex-1" id="facility-results-wrapper">
                <div id="facility-results">
                    {% include 'core/_facility_list_results.html' %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // 지역 선택 연동
        const regions = {{ regions|safe }};
        const sidoSelect = document.getElementById('sido');
        const sigunguSelect = document.getElementById('sigungu');
        const currentSigungu = '{{ current_filters.sigungu }}';

        function updateSigungu() {
            const selectedSido = sidoSelect.value;
            sigunguSelect.innerHTML = '<option value="">시/군/구 선택</option>';

            if (selectedSido && regions[selectedSido]) {
                regions[selectedSido].forEach(sigungu => {
                    const option = document.createElement('option');
                    option.value = sigungu;
                    option.textContent = sigungu;
                    if (sigungu === currentSigungu) {
                        option.selected = true;
                    }
                    sigunguSelect.appendChild(option);
                });
            }
        }

        sidoSelect.addEventListener('change', updateSigungu);

        // 페이지 로드시 시군구 업데이트
        if (sidoSelect.value) {
            updateSigungu();
        }

        // === AJAX 필터링/페이지네이션 ===
        const filterForm = document.querySelector('form');
        const resultsContainer = document.getElementById('facility-results');
        let typingTimer;
        const DEBOUNCE_MS = 400;

        function buildQueryParams(extra={}) {
            const fd = new FormData(filterForm);
            const params = new URLSearchParams();
            for (const [k,v] of fd.entries()) { if (v) params.set(k,v); }
            // extra override
            Object.entries(extra).forEach(([k,v])=>{ if (v===null) params.delete(k); else params.set(k,v); });
            params.set('ajax','1');
            return params.toString();
        }

        function setLoading() {
            resultsContainer.innerHTML = '<div class="py-16 text-center text-gray-500">불러오는 중...</div>';
        }

        function applyPaginationLinks() {
            const links = resultsContainer.querySelectorAll('.pagination a');
            links.forEach(a => {
                a.addEventListener('click', evt => {
                    evt.preventDefault();
                    const pageMatch = a.getAttribute('href').match(/page=(\d+)/);
                    const page = pageMatch ? pageMatch[1] : '1';
                    fetchAndRender({page});
                });
            });
        }

        async function fetchAndRender(extraParams={}) {
            setLoading();
            const qs = buildQueryParams(extraParams);
            const url = window.location.pathname + '?' + qs;
            try {
                const resp = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
                const html = await resp.text();
                resultsContainer.innerHTML = html;
                applyPaginationLinks();
                // 히스토리 업데이트 (사용자 back 가능)
                const historyParams = new URLSearchParams(qs);
                historyParams.delete('ajax');
                const historyUrl = window.location.pathname + '?' + historyParams.toString();
                window.history.replaceState({}, '', historyUrl);
            } catch(e) {
                resultsContainer.innerHTML = '<div class="py-16 text-center text-red-500">오류가 발생했습니다.</div>';
                console.error(e);
            }
        }

        // 폼 submit 가로채기
        filterForm.addEventListener('submit', e => { e.preventDefault(); fetchAndRender(); });

        // 입력 즉시/변경시 자동 검색 (검색어 debounce)
        filterForm.querySelectorAll('input[name="search"]').forEach(inp => {
            inp.addEventListener('input', () => {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(()=>fetchAndRender(), DEBOUNCE_MS);
            });
        });
        filterForm.querySelectorAll('select, input[type=radio]').forEach(el => {
            el.addEventListener('change', () => fetchAndRender());
        });

        // 초기 페이지네이션 링크 바인딩
        applyPaginationLinks();
    </script>
</body>
</html>
