<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ facility.name }} - 요양시설 상세정보</title>
    <!-- Open Graph / SEO -->
    <meta property="og:title" content="{{ facility.name }} | CareBridge" />
    <meta property="og:description" content="{% if summary_info and summary_info.is_generated %}{{ summary_info.content|truncatechars:120 }}{% else %}요양시설 상세정보{% endif %}" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="{% if images %}{{ images.0.image.url }}{% endif %}" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ facility.name }}" />
    <meta name="twitter:description" content="{% if summary_info and summary_info.is_generated %}{{ summary_info.content|truncatechars:120 }}{% else %}요양시설 상세정보{% endif %}" />
    <meta name="twitter:image" content="{% if images %}{{ images.0.image.url }}{% endif %}" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <!-- Google Maps JavaScript API -->
    {% if facility.latitude and facility.longitude and google_maps_api_key %}
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&language=ko&region=KR"></script>
    {% endif %}

    <style>
        body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica Neue',Arial,sans-serif;background:linear-gradient(160deg,#ffffff 0%,#f5f8fb 55%,#eef3f9 100%);color:#1e293b;}
        .hdr{transition:height .2s ease, box-shadow .2s ease, background .2s ease;}
        .hdr:not(.shrink){height:70px;}
        .hdr.shrink{height:56px;}
        .lightbox-fade-enter{opacity:0} .lightbox-fade-enter-active{opacity:1;transition:opacity .2s ease}
    </style>
</head>
<body class="min-h-screen">
<header id="siteHeader" class="hdr sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 flex flex-col justify-center">
    {% include 'core/_navbar.html' %}
</header>
<div class="max-w-6xl mx-auto">

<!-- 브레드크럼 -->
<nav aria-label="Breadcrumb" class="px-4 sm:px-6 lg:px-8 pt-4">
  <ol class="flex items-center text-xs sm:text-sm text-slate-500 gap-2">
    <li><a href="{% url 'core:main' %}" class="hover:text-slate-700">홈</a></li>
    <li><i class="fas fa-chevron-right text-slate-400 text-[10px]"></i></li>
    <li><a href="{% url 'core:facility_list' %}" class="hover:text-slate-700">시설검색</a></li>
    <li><i class="fas fa-chevron-right text-slate-400 text-[10px]"></i></li>
    <li class="text-slate-700 font-medium truncate max-w-[40ch]" aria-current="page">{{ facility.name }}</li>
  </ol>
</nav>

<!-- Above the Fold: 갤러리 + 타이틀 -->
<section class="mt-4 px-4 sm:px-6 lg:px-8">
  <h1 class="sr-only">{{ facility.name }} 상세정보</h1>
  {% if images and images|length > 0 %}
    <!-- 모바일 Swiper -->
    <div class="lg:hidden relative">
      <div class="swiper h-64 sm:h-80" id="mobileGallery">
        <div class="swiper-wrapper">
          {% for image in images %}
            <div class="swiper-slide">
              <img src="{{ image.image.url }}"
                   srcset="{{ image.image.url }} 480w, {{ image.image.url }} 960w, {{ image.image.url }} 1440w"
                   sizes="(max-width:640px) 100vw, 100vw"
                   alt="{{ facility.name }} 이미지 {{ forloop.counter }}"
                   loading="lazy"
                   class="w-full h-full object-cover rounded-xl cursor-pointer"
                   data-gallery-image="{{ forloop.counter0 }}" />
            </div>
          {% endfor %}
        </div>
        <div class="swiper-pagination"></div>
      </div>
      <button type="button" data-gallery-modal class="absolute bottom-3 right-3 bg-white/90 backdrop-blur px-3 h-9 rounded-full text-xs font-medium shadow hover:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="사진 모두 보기">사진 모두 보기</button>
    </div>

    <!-- 데스크톱 5-grid -->
    <div class="hidden lg:grid lg:grid-cols-4 lg:grid-rows-2 lg:gap-2 relative">
      {% for image in images|slice:':5' %}
        {% if forloop.first %}
          <div class="col-span-2 row-span-2 rounded-xl overflow-hidden relative group cursor-pointer" data-gallery-image="{{ forloop.counter0 }}">
            <img src="{{ image.image.url }}"
                 srcset="{{ image.image.url }} 480w, {{ image.image.url }} 960w, {{ image.image.url }} 1440w"
                 sizes="(min-width:1024px) 60vw, 100vw"
                 alt="{{ facility.name }} 대표 이미지" loading="lazy" class="w-full h-full object-cover aspect-[16/11] transition duration-300 group-hover:scale-[1.02]" />
          </div>
        {% else %}
          <div class="rounded-xl overflow-hidden relative group cursor-pointer" data-gallery-image="{{ forloop.counter0 }}">
            <img src="{{ image.image.url }}"
                 srcset="{{ image.image.url }} 480w, {{ image.image.url }} 960w, {{ image.image.url }} 1440w"
                 sizes="(min-width:1024px) 20vw, 100vw"
                 alt="{{ facility.name }} 추가 이미지 {{ forloop.counter }}" loading="lazy" class="w-full h-full object-cover aspect-[16/11] transition duration-300 group-hover:scale-[1.05]" />
          </div>
        {% endif %}
      {% endfor %}
      <button type="button" data-gallery-modal class="absolute bottom-4 right-4 bg-white/90 backdrop-blur px-4 h-10 rounded-full text-sm font-medium shadow hover:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="사진 모두 보기">사진 모두 보기</button>
    </div>
  {% else %}
    <div class="aspect-[16/11] rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 grid place-items-center text-gray-400 relative">
      <div class="flex flex-col items-center gap-2 text-sm font-medium"><i class="fa fa-camera text-xl"></i><span>이미지가 없습니다</span></div>
    </div>
  {% endif %}

  <!-- 타이틀 및 새 메타 -->
  <div class="mt-6 space-y-2">
    <div class="flex flex-wrap items-center gap-3">
      <h1 class="text-2xl font-bold tracking-tight text-slate-900">{{ facility.name }}</h1>
      {% if tags and tags|length > 0 %}
        <div class="flex flex-wrap gap-2">
          {% for tag in tags %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs border bg-gray-100 text-gray-700 border-gray-200">{{ tag.name }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    <div class="space-y-1 text-sm text-slate-600">
      {% if location_items and location_items|length > 0 %}
        {% with loc=location_items.0 %}
          {% if loc.content %}
            <div class="flex items-start gap-1 max-w-[60ch] truncate">
              <i class="fa fa-location-dot text-slate-400 mt-0.5 shrink-0" aria-hidden="true"></i>
              <span class="truncate">{{ loc.content }}</span>
            </div>
          {% endif %}
        {% endwith %}
      {% endif %}
      {% if homepage_info %}
        <div class="flex items-start gap-1 max-w-[50ch] truncate">
          <i class="fa fa-globe text-slate-400 mt-0.5 shrink-0" aria-hidden="true"></i>
          {% with raw=homepage_info.content %}
            {% if raw %}
              {% if '://' in raw %}
                <a href="{{ raw }}" target="_blank" rel="noopener noreferrer" class="truncate text-slate-700 hover:text-indigo-600 hover:underline" aria-label="홈페이지 새 창에서 열기">{{ raw }}</a>
              {% else %}
                <a href="http://{{ raw }}" target="_blank" rel="noopener noreferrer" class="truncate text-slate-700 hover:text-indigo-600 hover:underline" aria-label="홈페이지 새 창에서 열기">{{ raw }}</a>
              {% endif %}
            {% endif %}
          {% endwith %}
        </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- 레이아웃 본문 -->
<main class="mt-10 px-4 sm:px-6 lg:px-8 lg:grid lg:grid-cols-3 lg:gap-10 mb-24">
  <!-- 좌측 2컬럼 영역 -->
  <div class="lg:col-span-2 space-y-8">

    <!-- 공통 섹션 렌더 헬퍼 패턴 반복 -->
    <section class="bg-white rounded-2xl border p-6 lg:p-8 shadow-sm hover:shadow transition">
      <h2 class="text-xl font-bold mb-5">기본 정보</h2>
      {% if basic_items and basic_items|length > 0 %}
        <div class="space-y-5">
          {% for item in basic_items %}
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
              <h3 class="sm:w-40 font-medium text-slate-700 shrink-0">{{ item.title }}</h3>
              <p class="flex-1 text-slate-900 whitespace-pre-line">{{ item.content|default:"정보 없음" }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}<p class="text-gray-500">등록된 항목이 없습니다.</p>{% endif %}
    </section>
    <section class="bg-white rounded-2xl border p-6 lg:p-8 shadow-sm hover:shadow transition">
      <h2 class="text-xl font-bold mb-5">평가 정보</h2>
      {% if evaluation_items and evaluation_items|length > 0 %}
        <div class="space-y-5">
          {% for item in evaluation_items %}
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
              <h3 class="sm:w-40 font-medium text-slate-700 shrink-0">{{ item.title }}</h3>
              <p class="flex-1 text-slate-900 whitespace-pre-line">{{ item.content|default:"정보 없음" }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}<p class="text-gray-500">등록된 항목이 없습니다.</p>{% endif %}
    </section>
    <section class="bg-white rounded-2xl border p-6 lg:p-8 shadow-sm hover:shadow transition">
      <h2 class="text-xl font-bold mb-5">인력 현황</h2>
      {% if staff_items and staff_items|length > 0 %}
        <div class="space-y-5">
          {% for item in staff_items %}
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
              <h3 class="sm:w-40 font-medium text-slate-700 shrink-0">{{ item.title }}</h3>
              <p class="flex-1 text-slate-900 whitespace-pre-line">{{ item.content|default:"정보 없음" }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}<p class="text-gray-500">등록된 항목이 없습니다.</p>{% endif %}
    </section>
    <section class="bg-white rounded-2xl border p-6 lg:p-8 shadow-sm hover:shadow transition">
      <h2 class="text-xl font-bold mb-5">프로그램 운영</h2>
      {% if program_items and program_items|length > 0 %}
        <div class="space-y-5">
          {% for item in program_items %}
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
              <h3 class="sm:w-40 font-medium text-slate-700 shrink-0">{{ item.title }}</h3>
              <p class="flex-1 text-slate-900 whitespace-pre-line">{{ item.content|default:"정보 없음" }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}<p class="text-gray-500">등록된 항목이 없습니다.</p>{% endif %}
    </section>
    <section class="bg-white rounded-2xl border p-6 lg:p-8 shadow-sm hover:shadow transition">
      <h2 class="text-xl font-bold mb-5">위치 정보</h2>
      {% if location_items and location_items|length > 0 %}
        <div class="space-y-5">
          {% for item in location_items %}
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
              <h3 class="sm:w-40 font-medium text-slate-700 shrink-0">{{ item.title }}</h3>
              <p class="flex-1 text-slate-900 whitespace-pre-line">{{ item.content|default:"정보 없음" }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-gray-500">등록된 항목이 없습니다.</p>
      {% endif %}

      <!-- Google Maps 추가 -->
      {% if facility.latitude and facility.longitude and google_maps_api_key %}
        <div class="mt-6">
          <h3 class="font-medium text-slate-700 mb-3">지도</h3>
          <div id="facilityMap" data-lat="{{ facility.latitude }}" data-lng="{{ facility.longitude }}" class="w-full h-64 rounded-lg border bg-gray-100 flex items-center justify-center">
            <div class="text-gray-500" id="mapLoading">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              지도를 불러오는 중...
            </div>
          </div>
        </div>
      {% elif facility.location %}
        <div class="mt-6">
          <h3 class="font-medium text-slate-700 mb-3">지도</h3>
          <div class="w-full h-32 rounded-lg border bg-gray-50 flex items-center justify-center">
            <div class="text-gray-500 text-center">
              <i class="fas fa-map-marker-alt mb-2"></i>
              <p class="text-sm">좌표 정보가 없어 지도를 표시할 수 없습니다.</p>
              <p class="text-xs text-gray-400">주소: {{ facility.location }}</p>
            </div>
          </div>
        </div>
      {% endif %}
    </section>
    <section class="bg-white rounded-2xl border p-6 lg:p-8 shadow-sm hover:shadow transition">
      <h2 class="text-xl font-bold mb-5">비급여 항목</h2>
      {% if noncovered_items and noncovered_items|length > 0 %}
        <div class="space-y-5">
          {% for item in noncovered_items %}
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
              <h3 class="sm:w-40 font-medium text-slate-700 shrink-0">{{ item.title }}</h3>
              <p class="flex-1 text-slate-900 whitespace-pre-line">{{ item.content|default:"정보 없음" }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}<p class="text-gray-500">등록된 항목이 없습니다.</p>{% endif %}
    </section>
    <section class="bg-white rounded-2xl border p-6 lg:p-8 shadow-sm hover:shadow transition">
      <h2 class="text-xl font-bold mb-5">홈페이지</h2>
      {% if homepage_info %}
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
          <h3 class="sm:w-40 font-medium text-slate-700 shrink-0">{{ homepage_info.title|default:"정보" }}</h3>
          <div class="flex-1 text-slate-900 whitespace-pre-line">{{ homepage_info.content|default:"정보 없음" }}</div>
        </div>
      {% else %}<p class="text-gray-500">등록된 항목이 없습니다.</p>{% endif %}
    </section>

    <!-- 하단 액션 -->
    <div class="flex flex-wrap gap-3 pt-4">
      <a href="{% url 'core:facility_list' %}" class="inline-flex items-center gap-2 px-5 h-11 rounded-xl border border-slate-300 bg-white hover:border-slate-500 text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"><i class="fa fa-arrow-left"></i>목록으로</a>
      <button type="button" onclick="window.print()" class="inline-flex items-center gap-2 px-5 h-11 rounded-xl border border-slate-300 bg-white hover:border-slate-500 text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="인쇄하기"><i class="fa fa-print"></i>인쇄하기</button>
      <button type="button" class="inline-flex items-center gap-2 px-5 h-11 rounded-xl border border-slate-300 bg-white hover:border-slate-500 text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="shareBottomBtn" aria-label="공유하기"><i class="fa fa-share"></i>공유하기</button>
    </div>
  </div>

  <!-- 우측 사이드바 -->
  <aside class="mt-10 lg:mt-0 space-y-6">
    <div class="bg-white rounded-2xl border p-6 lg:p-8 shadow-sm sticky top-24">
      <h2 class="text-lg font-bold mb-5">시설 현황</h2>
      <div class="space-y-4 text-sm">
        {% if facility.capacity is not None %}
          <div class="flex justify-between"><span class="text-slate-600">정원</span><span class="font-semibold text-slate-900">{{ facility.capacity }}명</span></div>
        {% endif %}
        {% if facility.occupancy is not None %}
          <div class="flex justify-between"><span class="text-slate-600">현원</span><span class="font-semibold text-indigo-600">{{ facility.occupancy }}명</span></div>
        {% endif %}
        {% if facility.waiting is not None %}
          <div class="flex justify-between"><span class="text-slate-600">대기</span><span class="font-semibold text-orange-600">{{ facility.waiting }}명</span></div>
        {% endif %}
        {% if facility.capacity is not None and facility.occupancy is not None %}
          <div class="flex justify-between pt-3 border-t"><span class="text-slate-600">입소율</span><span class="font-semibold text-slate-900">{% widthratio facility.occupancy facility.capacity 100 %}%</span></div>
        {% endif %}
      </div>
      <div class="mt-6 flex flex-col gap-3">
        <button type="button" class="w-full inline-flex items-center justify-center gap-2 h-11 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500" id="shareSideBtn" aria-label="공유하기">공유</button>
      </div>
    </div>
  </aside>
</main>
</div><!-- /max-width wrapper -->

{% include 'core/_footer.html' %}

<!-- Lightbox Modal 컨테이너 (동적 생략) -->
<div id="galleryModalRoot"></div>

<script>
(function(){
  console.log('스크립트 시작');

  // DOM이 완전히 로드된 후 실행
  function initializeComponents() {
    console.log('컴포넌트 초기화 시작');

    // Swiper 초기화
    function initSwiper() {
      const swiperEl = document.getElementById('mobileGallery');
      if(swiperEl && typeof Swiper !== 'undefined'){
        console.log('Swiper 초기화');
        new Swiper('#mobileGallery', {
          loop: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true
          }
        });
      }
    }

    // Swiper 스크립트 로드 확인 후 초기화
    if(typeof Swiper !== 'undefined') {
      initSwiper();
    } else {
      // Swiper가 아직 로드되지 않은 경우 잠시 후 재시도
      let retryCount = 0;
      const maxRetries = 10;
      const retryInterval = setInterval(() => {
        if(typeof Swiper !== 'undefined') {
          initSwiper();
          clearInterval(retryInterval);
        } else if(retryCount >= maxRetries) {
          console.warn('Swiper 로드 실패');
          clearInterval(retryInterval);
        }
        retryCount++;
      }, 100);
    }

    // 헤더 shrink
    const header=document.getElementById('siteHeader');
    const shrinkTitle=document.getElementById('shrinkTitle');
    function onScroll(){
      if(window.scrollY>120){
        header.classList.add('shrink');
        if(shrinkTitle) shrinkTitle.classList.remove('hidden');
      } else {
        header.classList.remove('shrink');
        if(shrinkTitle) shrinkTitle.classList.add('hidden');
      }
    }
    window.addEventListener('scroll',onScroll,{passive:true});
    onScroll();

    // 공유 기능
    function doShare(){
      const data={title:'{{ facility.name }}', text:'{{ facility.name }}', url:window.location.href};
      if(navigator.share){
        navigator.share(data).catch(()=>copy());
      } else {
        copy();
      }
    }
    function copy(){
      if(navigator.clipboard){
        navigator.clipboard.writeText(window.location.href).then(()=>alert('링크가 복사되었습니다.'));
      }
    }
    ['shareTopBtn','shareBottomBtn','shareSideBtn'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.addEventListener('click',doShare);
    });

    // 갤러리 모달 초기화
    initGalleryModal();
  }

  // 갤러리 모달 기능
  function initGalleryModal() {
    console.log('갤러리 모달 초기화 시작');

    const modalRoot=document.getElementById('galleryModalRoot');
    if(!modalRoot) {
      console.error('galleryModalRoot를 찾을 수 없습니다');
      return;
    }

    function openModal(startIndex = 0){
      console.log('갤러리 모달 열기 시도, 시작 인덱스:', startIndex);

      // 이미 열린 모달이 있으면 무시
      if(modalRoot.querySelector('[data-lightbox-root]')) {
        console.log('이미 모달이 열려있습니다');
        return;
      }

      const imgs=[
        {% if images and images|length > 0 %}
          {% for image in images %}'{{ image.image.url }}'{% if not forloop.last %},{% endif %}{% endfor %}
        {% endif %}
      ];

      console.log('이미지 배열:', imgs);

      if(imgs.length === 0) {
        alert('표시할 이미지가 없습니다.');
        return;
      }

      const html = `
        <div data-lightbox-root class="fixed inset-0 z-[70]" role="dialog" aria-modal="true">
          <div data-backdrop class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
          <div class="absolute inset-0 flex flex-col">
            <div class="flex items-center justify-between px-4 h-14 text-white">
              <span class="font-medium truncate pr-4">사진 (${imgs.length})</span>
              <button aria-label="닫기" class="h-8 px-3 rounded-md hover:bg-white/10 text-sm" data-close>닫기</button>
            </div>
            <div class="flex-1 overflow-hidden flex items-center justify-center relative">
              <button class="hidden md:inline-flex absolute left-3 top-1/2 -translate-y-1/2 h-10 px-3 items-center justify-center text-white rounded-md bg-black/30 hover:bg-black/50 text-sm" data-prev aria-label="이전">이전</button>
              <img class="max-h-full max-w-full object-contain transition" alt="{{ facility.name }} 확대 이미지" data-main />
              <button class="hidden md:inline-flex absolute right-3 top-1/2 -translate-y-1/2 h-10 px-3 items-center justify-center text-white rounded-md bg-black/30 hover:bg-black/50 text-sm" data-next aria-label="다음">다음</button>
            </div>
            <div class="p-4 overflow-x-auto bg-black/40">
              <div class="flex gap-2" data-thumbs></div>
            </div>
          </div>
        </div>
      `;

      modalRoot.insertAdjacentHTML('beforeend', html);

      const root = modalRoot.querySelector('[data-lightbox-root]');
      const main = root.querySelector('[data-main]');
      const thumbs = root.querySelector('[data-thumbs]');
      let idx = Math.max(0, Math.min(startIndex, imgs.length - 1)); // 시작 인덱스 설정

      function render(){
        if(!imgs.length) return;
        main.src = imgs[idx];
        console.log('이미지 로드:', imgs[idx]);

        // 현재 선택된 썸네일 하이라이트
        thumbs.querySelectorAll('button').forEach((btn, i) => {
          if(i === idx) {
            btn.classList.add('ring-2', 'ring-indigo-400');
          } else {
            btn.classList.remove('ring-2', 'ring-indigo-400');
          }
        });
      }

      // 썸네일 생성
      imgs.forEach((src,i)=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'relative flex-shrink-0 h-16 w-24 rounded-md overflow-hidden border border-white/20 ring-offset-2 focus:outline-none focus:ring-2 focus:ring-indigo-400';
        b.innerHTML = `<img src="${src}" alt="썸네일 ${i+1}" class="w-full h-full object-cover" loading="lazy" />`;
        b.addEventListener('click',()=>{ idx=i; render(); });
        thumbs.appendChild(b);
      });

      function close(){
        console.log('모달 닫기');
        root.remove();
      }

      // 이벤트 리스너 등록
      root.querySelector('[data-close]').addEventListener('click', close);
      root.addEventListener('click', e => {
        if(e.target.hasAttribute('data-backdrop')) close();
      });

      const prevBtn = root.querySelector('[data-prev]');
      const nextBtn = root.querySelector('[data-next]');

      function prev(){ idx = (idx-1+imgs.length) % imgs.length; render(); }
      function next(){ idx = (idx+1) % imgs.length; render(); }

      if(prevBtn) prevBtn.addEventListener('click', prev);
      if(nextBtn) nextBtn.addEventListener('click', next);

      // 키보드 이벤트
      function keyHandler(ev){
        if(!root.isConnected) {
          document.removeEventListener('keydown', keyHandler);
          return;
        }
        if(ev.key === 'Escape') close();
        else if(ev.key === 'ArrowLeft') prev();
        else if(ev.key === 'ArrowRight') next();
      }
      document.addEventListener('keydown', keyHandler);

      // 선택된 인덱스의 이미지로 시작
      render();
      console.log('모달이 성공적으로 열렸습니다');
    }

    // 갤러리 모달 버튼에 이벤트 리스너 등록 ("사진 모두 보기" 버튼)
    const galleryButtons = document.querySelectorAll('[data-gallery-modal]');
    console.log('찾은 갤러리 버튼 수:', galleryButtons.length);

    galleryButtons.forEach((btn, index) => {
      console.log(`갤러리 버튼 ${index + 1} 찾음:`, btn);
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('갤러리 버튼 클릭됨');
        openModal(0); // 첫 번째 이미지부터 시작
      });
    });

    // 개별 이미지 클릭 이벤�� 리스너 등록
    const galleryImages = document.querySelectorAll('[data-gallery-image]');
    console.log('찾은 갤러리 이미지 수:', galleryImages.length);

    galleryImages.forEach((element, index) => {
      console.log(`갤러리 이미지 ${index + 1} 찾음:`, element);
      element.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const imageIndex = parseInt(element.getAttribute('data-gallery-image')) || 0;
        console.log('개별 이미지 클릭됨, 인덱스:', imageIndex);
        openModal(imageIndex); // 클릭한 이미지부터 ���작
      });
    });

    console.log('갤러리 모달 초기화 완료');
  }

  // DOM 로드 완료 확인
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeComponents);
  } else {
    // 이미 로드된 경우 즉시 실행
    initializeComponents();
  }

  console.log('스크립트 설정 완료');
})();

// Google Maps 초기화 함수 (전역 함수로 선언)
{% if facility.latitude and facility.longitude and google_maps_api_key %}
function initMap() {
  const mapElement = document.getElementById('facilityMap');
  if (!mapElement) return;

  // dataset에서 안전하게 숫자 파싱
  const lat = parseFloat(mapElement.dataset.lat);
  const lng = parseFloat(mapElement.dataset.lng);
  if (isNaN(lat) || isNaN(lng)) {
    mapElement.innerHTML = '<div class="text-red-500 text-sm p-4">좌표 파싱 오류</div>';
    return;
  }

  // 먼저 로딩 오버레이 제거
  const loadingEl = document.getElementById('mapLoading');
  if (loadingEl) loadingEl.remove();

  // 지도 생성
  const facilityLocation = { lat, lng };
  const map = new google.maps.Map(mapElement, {
    zoom: 16,
    center: facilityLocation,
    streetViewControl: false,
    fullscreenControl: true,
    mapTypeControl: false,
    styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
  });

  const marker = new google.maps.Marker({
    position: facilityLocation,
    map,
    title: '{{ facility.name|escapejs }}'
  });

  const infoWindow = new google.maps.InfoWindow({
    content: `
      <div style="padding:8px 8px 10px;max-width:240px">
        <h3 style="margin:0 0 6px;font-size:15px;font-weight:600;color:#1e293b">{{ facility.name|escapejs }}</h3>
        {% if location_items and location_items.0.content %}<p style="margin:0 0 8px;font-size:13px;line-height:1.4;color:#475569">{{ location_items.0.content|escapejs }}</p>{% endif %}
        <button onclick="openDirections()" style="background:#4F46E5;color:#fff;border:0;padding:6px 10px;border-radius:6px;font-size:12px;cursor:pointer">길찾기</button>
      </div>`
  });
  marker.addListener('click', () => infoWindow.open(map, marker));
}

function openDirections() {
  const mapElement = document.getElementById('facilityMap');
  if (!mapElement) return;
  const lat = mapElement.dataset.lat;
  const lng = mapElement.dataset.lng;
  window.open(`https://maps.google.com/maps?daddr=${lat},${lng}`, '_blank');
}

window.gm_authFailure = function() {
  const mapElement = document.getElementById('facilityMap');
  if (mapElement) {
    mapElement.innerHTML = '<div class="text-red-500 text-center p-4 text-sm">지도 API 인증 실패 (API 키 확인)</div>';
  }
};
{% endif %}
</script>
</body>
</html>
